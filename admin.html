<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — GODs Turf</title>
  <link rel="icon" href="./assets/logo.svg" type="image/svg+xml"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> body{font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;} </style>
</head>
<body class="bg-white text-gray-900">
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a class="flex items-center gap-2" href="./index.html">
        <img src="./assets/logo.svg" class="h-8 w-8" alt="logo">
        <span class="font-bold">Admin — <span id="bizName">GODs Turf</span></span>
      </a>
      <div class="flex items-center gap-2">
        <a href="./index.html" class="px-3 py-2 rounded-xl border">Back to site</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-6 flex gap-2">
      <button id="tabBookings" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Bookings</button>
      <button id="tabWaitlist" class="px-3 py-2 rounded-xl border">Waitlist</button>
      <button id="tabNotifications" class="px-3 py-2 rounded-xl border">Notifications</button>
    </div>

    <!-- Controls -->
    <div id="controls" class="mb-6 flex flex-wrap items-end gap-3">
      <div class="flex gap-2 items-end">
        <label class="text-sm text-gray-600">Date</label>
        <input id="filterDate" type="date" class="border rounded-xl px-3 py-2"/>
      </div>

      <div class="flex gap-2 items-end">
        <label class="text-sm text-gray-600">Court</label>
        <select id="filterCourt" class="border rounded-xl px-3 py-2">
          <option value="">All courts</option>
        </select>
      </div>

      <button id="exportCsv" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Export CSV</button>
      <button id="clearAll" class="px-3 py-2 rounded-xl border text-red-600">Delete All Bookings</button>
      <button id="refreshBtn" class="px-3 py-2 rounded-xl border">Refresh</button>
    </div>

    <!-- Bookings table -->
    <section id="bookingsSection" class="mb-8">
      <div class="overflow-auto border rounded-2xl">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left">ID</th>
              <th class="px-3 py-2 text-left">Status</th>
              <th class="px-3 py-2 text-left">Court</th>
              <th class="px-3 py-2 text-left">Date</th>
              <th class="px-3 py-2 text-left">Start</th>
              <th class="px-3 py-2 text-left">Customer</th>
              <th class="px-3 py-2 text-left">Amount</th>
              <th class="px-3 py-2 text-left">Notes</th>
              <th class="px-3 py-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <!-- Waitlist -->
    <section id="waitlistSection" class="hidden mb-8">
      <h2 class="font-semibold mb-2">Waitlist</h2>
      <div class="overflow-auto border rounded-2xl">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left">ID</th>
              <th class="px-3 py-2 text-left">Court</th>
              <th class="px-3 py-2 text-left">Date</th>
              <th class="px-3 py-2 text-left">Time</th>
              <th class="px-3 py-2 text-left">Customer</th>
              <th class="px-3 py-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="wlRows"></tbody>
        </table>
      </div>
    </section>

    <!-- Notifications -->
    <section id="notificationsSection" class="hidden mb-8">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Admin Notifications</h2>
        <div>
          <button id="markAllRead" class="px-3 py-1 rounded-xl border text-sm">Mark all read</button>
          <button id="clearNotifs" class="px-3 py-1 rounded-xl border text-sm text-red-600">Clear</button>
        </div>
      </div>
      <div id="adminNotifs" class="overflow-auto border rounded-2xl p-3 text-sm"></div>
    </section>

    <p class="text-xs text-gray-500 mt-2">* Demo admin uses browser storage. Wire it to a backend for production.</p>
  </main>

  <!-- Include app.js first so confirmBooking() and helpers exist -->
  <script src="./scripts/app.js"></script>

  <script>
    // Admin page script
    (function(){
      const bookingsKey = 'turf_bookings_v1';
      const waitlistKey = 'turf_waitlist_v1';
      const notifsKey = 'turf_notifications_v1';

      function loadBookings(){ try{ return JSON.parse(localStorage.getItem(bookingsKey)||'[]'); }catch(e){ return []; } }
      function saveBookings(rows){ localStorage.setItem(bookingsKey, JSON.stringify(rows)); }
      function loadWaitlist(){ try{ return JSON.parse(localStorage.getItem(waitlistKey)||'[]'); }catch(e){ return []; } }
      function saveWaitlist(rows){ localStorage.setItem(waitlistKey, JSON.stringify(rows)); }
      function loadNotifs(){ try{ return JSON.parse(localStorage.getItem(notifsKey)||'[]'); }catch(e){ return []; } }
      function saveNotifs(rows){ localStorage.setItem(notifsKey, JSON.stringify(rows)); }

      const $ = (s, el=document)=> el.querySelector(s);
      const $$ = (s, el=document)=> [...el.querySelectorAll(s)];

      // Elements
      const rowsEl = $('#rows');
      const wlRowsEl = $('#wlRows');
      const filterDate = $('#filterDate');
      const filterCourt = $('#filterCourt');
      const exportCsvBtn = $('#exportCsv');
      const clearAllBtn = $('#clearAll');
      const refreshBtn = $('#refreshBtn');
      const adminNotifs = $('#adminNotifs');
      const markAllReadBtn = $('#markAllRead');
      const clearNotifsBtn = $('#clearNotifs');

      // Tabs
      const tabBookings = $('#tabBookings');
      const tabWaitlist = $('#tabWaitlist');
      const tabNotifs = $('#tabNotifications');
      const bookingsSection = $('#bookingsSection');
      const waitlistSection = $('#waitlistSection');
      const notificationsSection = $('#notificationsSection');

      tabBookings.onclick = ()=> { bookingsSection.classList.remove('hidden'); waitlistSection.classList.add('hidden'); notificationsSection.classList.add('hidden'); };
      tabWaitlist.onclick = ()=> { bookingsSection.classList.add('hidden'); waitlistSection.classList.remove('hidden'); notificationsSection.classList.add('hidden'); };
      tabNotifs.onclick = ()=> { bookingsSection.classList.add('hidden'); waitlistSection.classList.add('hidden'); notificationsSection.classList.remove('hidden'); };

      // Populate courts from site.json
      async function populateCourts(){
        try{
          const cfg = await fetch('./data/site.json').then(r=>r.json());
          $('#bizName').textContent = cfg.name || $('#bizName').textContent;
          filterCourt.innerHTML = '<option value="">All courts</option>';
          (cfg.courts||[]).forEach(c=>{
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.label;
            filterCourt.appendChild(opt);
          });
        }catch(e){
          console.warn('Could not load site.json', e);
        }
      }

      function renderBookings(){
        const all = loadBookings();
        const date = filterDate.value;
        const court = filterCourt.value;
        const filtered = all.filter(b=>{
          if(date && b.dateISO !== date) return false;
          if(court && b.courtId !== court) return false;
          return true;
        }).sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
        rowsEl.innerHTML = filtered.map(b=>{
          const start = new Date(b.startISO);
          const startTime = start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          const statusBadge = b.status === 'confirmed' 
            ? `<span class="px-2 py-1 rounded-full text-xs bg-emerald-100 text-emerald-700">Confirmed</span>`
            : `<span class="px-2 py-1 rounded-full text-xs bg-amber-100 text-amber-700">Pending</span>`;
          return `<tr class="border-t">
            <td class="px-3 py-2 align-top">${b.id}</td>
            <td class="px-3 py-2 align-top">${statusBadge}</td>
            <td class="px-3 py-2 align-top">${b.courtLabel || b.courtId}</td>
            <td class="px-3 py-2 align-top">${b.dateISO}</td>
            <td class="px-3 py-2 align-top">${startTime}</td>
            <td class="px-3 py-2 align-top">${escapeHtml(b.name)}<div class="text-xs text-gray-500">${escapeHtml(b.phone)}</div></td>
            <td class="px-3 py-2 align-top">${money(b.price)}</td>
            <td class="px-3 py-2 align-top">${escapeHtml(b.notes || '')}</td>
            <td class="px-3 py-2 align-top">
              ${b.status !== 'confirmed' ? `<button data-id="${b.id}" class="confirm-btn px-3 py-1 rounded-xl bg-emerald-600 text-white text-sm">Confirm</button>` : ''}
              <button data-id="${b.id}" class="view-btn mt-1 px-3 py-1 rounded-xl border text-sm">View</button>
              <button data-id="${b.id}" class="delete-btn mt-1 px-3 py-1 rounded-xl border text-sm text-red-600">Delete</button>
            </td>
          </tr>`;
        }).join('') || '<tr><td class="p-4" colspan="9"><em>No bookings match the selected filters.</em></td></tr>';
        attachRowHandlers();
      }

      function renderWaitlist(){
        const rows = loadWaitlist().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
        wlRowsEl.innerHTML = rows.map(r=>{
          const when = new Date(r.startISO).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          return `<tr class="border-t">
            <td class="px-3 py-2">${r.id}</td>
            <td class="px-3 py-2">${escapeHtml(r.courtId)}</td>
            <td class="px-3 py-2">${r.dateISO}</td>
            <td class="px-3 py-2">${when}</td>
            <td class="px-3 py-2">${escapeHtml(r.name)}<div class="text-xs text-gray-500">${escapeHtml(r.phone)}</div></td>
            <td class="px-3 py-2">
              <button data-id="${r.id}" class="wl-delete-btn px-3 py-1 rounded-xl border text-sm text-red-600">Remove</button>
            </td>
          </tr>`;
        }).join('') || '<tr><td class="p-4" colspan="6"><em>No waitlist entries.</em></td></tr>';
        attachWaitlistHandlers();
      }

      function renderNotifs(){
        const rows = loadNotifs();
        if(!rows.length){ adminNotifs.innerHTML = '<p class="p-4 text-sm text-gray-600">No notifications.</p>'; return; }
        adminNotifs.innerHTML = rows.map(n=>{
          return `<div class="border-b py-2">
            <div class="flex items-start justify-between">
              <div>
                <div class="font-medium">${escapeHtml(n.title)}</div>
                <div class="text-xs text-gray-600 mt-1 whitespace-pre-wrap">${escapeHtml(n.body)}</div>
              </div>
              <div class="text-xs text-gray-400">${new Date(n.createdAt).toLocaleString()}</div>
            </div>
          </div>`;
        }).join('');
      }

      function attachRowHandlers(){
        $$('.confirm-btn').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.dataset.id;
            if(!confirm('Confirm booking and mark as paid (offline)?')) return;
            // call global confirmBooking (provided by app.js). Use try/catch in case it's not available.
            if(typeof confirmBooking === 'function'){
              await confirmBooking(id, 'Paid at counter');
            } else {
              // fallback: update locally
              const rows = loadBookings();
              const idx = rows.findIndex(r=> r.id === id);
              if(idx !== -1){ rows[idx].status = 'confirmed'; rows[idx].confirmedAt = new Date().toISOString(); saveBookings(rows); pushAdminNotification({type:'booking-confirmed', title:`Booking confirmed — ${id}`, body:`Confirmed by admin`, bookingId:id}); }
            }
            renderBookings();
            renderNotifs();
          };
        });

        $$('.delete-btn').forEach(btn=>{
          btn.onclick = ()=>{
            const id = btn.dataset.id;
            if(!confirm('Delete this booking?')) return;
            const rows = loadBookings().filter(r=> r.id !== id);
            saveBookings(rows);
            pushAdminNotification({ type:'booking-deleted', title:`Booking deleted — ${id}`, body:`Deleted by admin`, bookingId: id });
            renderBookings();
            renderNotifs();
          };
        });

        $$('.view-btn').forEach(btn=>{
          btn.onclick = ()=>{
            const id = btn.dataset.id;
            const b = loadBookings().find(r=> r.id === id);
            if(!b) return alert('Booking not found');
            alert(`Booking ${b.id}\nCourt: ${b.courtLabel}\nDate: ${b.dateISO}\nTime: ${new Date(b.startISO).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}\nName: ${b.name}\nPhone: ${b.phone}\nNotes: ${b.notes || ''}\nStatus: ${b.status || 'pending'}`);
          };
        });
      }

      function attachWaitlistHandlers(){
        $$('.wl-delete-btn').forEach(btn=>{
          btn.onclick = ()=>{
            const id = btn.dataset.id;
            if(!confirm('Remove this waitlist entry?')) return;
            const rows = loadWaitlist().filter(r=> r.id !== id);
            saveWaitlist(rows);
            pushAdminNotification({ type:'waitlist-removed', title:`Waitlist removed — ${id}`, body:`Removed by admin`, bookingId: id });
            renderWaitlist();
            renderNotifs();
          };
        });
      }

      // Utilities
      function money(n){ return '₹' + Number(n||0).toLocaleString('en-IN'); }
      function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

      // Export CSV of currently filtered bookings
      function exportCsv(){
        const all = loadBookings();
        const date = filterDate.value;
        const court = filterCourt.value;
        const filtered = all.filter(b=>{
          if(date && b.dateISO !== date) return false;
          if(court && b.courtId !== court) return false;
          return true;
        });
        if(!filtered.length){ alert('No bookings to export for selected filters.'); return; }
        const headers = ['id','status','courtId','courtLabel','dateISO','startISO','endISO','name','phone','price','notes','createdAt','confirmedAt'];
        const rows = [headers.join(',')].concat(filtered.map(b=> headers.map(h=>{
          const v = b[h] ?? '';
          return `"${String(v).replace(/"/g,'""')}"`;
        }).join(',')));
        const csv = rows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bookings-${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Delete all bookings
      function clearAllBookings(){
        if(!confirm('Delete ALL bookings? This cannot be undone.')) return;
        localStorage.removeItem(bookingsKey);
        pushAdminNotification({ type:'bookings-cleared', title:'All bookings deleted', body:'Admin cleared all bookings', bookingId: null });
        renderBookings();
        renderNotifs();
      }

      // Notifications controls
      markAllReadBtn.onclick = ()=>{
        const rows = loadNotifs();
        rows.forEach(r=> r.read = true);
        saveNotifs(rows);
        renderNotifs();
      };
      clearNotifsBtn.onclick = ()=>{
        if(!confirm('Clear all notifications?')) return;
        localStorage.removeItem(notifsKey);
        renderNotifs();
      };

      // Event wiring
      exportCsvBtn.onclick = exportCsv;
      clearAllBtn.onclick = clearAllBookings;
      refreshBtn.onclick = ()=> { renderBookings(); renderWaitlist(); renderNotifs(); };

      filterDate.onchange = renderBookings;
      filterCourt.onchange = renderBookings;

      // React to booking:confirmed event from app.js
      window.addEventListener('booking:confirmed', (ev)=>{
        // refresh lists and notifs
        renderBookings();
        renderNotifs();
      });

      // initial load
      (async function start(){
        await populateCourts();
        // set default filter date to today
        filterDate.value = new Date().toISOString().slice(0,10);
        renderBookings();
        renderWaitlist();
        renderNotifs();
      })();

    })();
  </script>
</body>
</html>
